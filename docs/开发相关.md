# 项目目录说明
该部分解释说明本项目主体目录(二级目录未完全列出)
- addons:插件目录,主要使用RGa_PVZ和anim_player_refactor插件处理动画
- animation:动画目录,保存所有动画文件,大部分动画都是单独保存为tres格式文件,少部分保存在场景文件中
- assets: 资产文件夹,包含图片素材 音乐音效素材等,考虑到版权问题,<mark>github中将该目录删除,加群或者从大版本更新视频简介获取完整项目内容</mark>
- data: 主要保存Theme主题资源 和 数据文件(图鉴数据)
- docs: 文档目录,保存项目说明文档
- readme_show: readme展示的相关图片资源
- resources: 资源文件夹
- - character_resouce: 角色相关资源文件夹:body掉血变化\植物种植条件 <mark>(植物种植条件资源必须保存在该目录下)</mark>
- - crazy_dave_resource: 戴夫对话资源
- - <mark>level_date_resource: 游戏关卡设置相关的资源文件</mark>
- scenes:场景文件
- scripts: 脚本文件
- - autoload: 自动加载的全局脚本文件
- - bullet: 子弹脚本文件
- - character: 角色脚本文件(僵尸\植物\组件)
- - resources: 自定义资源脚本文件(关卡\植物种植条件\戴夫对话\body变化)
- shaders: 着色器脚本文件
- shader_material: 材质文件,保存僵尸出土时材质设置

# 测试
直接运行游戏场景文件会使用游戏场景文件export的参数文件，同时卡片无cd,可以通过修改MainGame节点测试相关的参数（阳光、速度、删除僵尸）测试游戏

# 植物僵尸动画
使用[R2Ga_PVZ](#r2ga_pvz)将植物大战僵尸的动画文件转换为Godot游戏引擎所支持的动画格式。

僵尸动画：
- 使用插件[anim_player_refactor](#anim_player_refactor)删除一些轨道，主要是删除删除僵尸胳膊和头相关的visible轨道，僵尸掉手或掉头时使用代码控制visible。
- 或者将需要使用代码隐藏的节点用一个新的Node2D节点作为其父节点，代码控制其显示与隐藏，不用修改动画文件（推荐）

植物动画：
- 植物射击时眨眼和idle时眨眼节点不同，由于射击时眨眼动画需要使用visible轨道，使用插件[anim_player_refactor](#anim_player_refactor)将idle时的眨眼节点visible轨道删除，使用代码控制植物眨眼。

# 子弹
## 子弹类型
子弹分为4类: 直线\抛物线\追踪子弹\ 其他（加农炮）
### 直线
直线型 非穿透性攻击 子弹在碰撞到屋顶斜坡时判断是否破碎

### 抛物线
抛物线子弹使用贝塞尔曲线控制子弹弹道,根据目标僵尸位置确定终点位置,可以跟随僵尸移动,僵尸移动超出一定限制,固定最终落点

### 追踪子弹
追踪子弹根据贝塞尔曲线每帧更新移动方向

### 加农炮子弹
加农炮子弹继承Node2D节点,与子弹基类无继承关系



## 子弹攻击碎片溅射
- 创建GPUParticles2D
- texture(GPUParticles2D) 添加子弹碎片图集
- material(CnavasItem) 添加CanvasItemMaterial
	- 修改对应的articles_anim_h_frames和particles_anim_v_frames
- process_material(GPUParticles2D) 添加ParticleProcessMaterial
	- 修改Display-Animation-Offset
- 修改粒子特效相关属性（初始方向，重力加速度，时间缩放）

# 碰撞相关

## 碰撞检测

### 斜面地图
角色受击碰撞箱分为两类: 检测受击碰撞箱和真实受击碰撞箱
非斜面(屋顶)地图:检测受击碰撞箱和真实受击碰撞箱重合
斜面(屋顶)地图:
- 定义两个层面: 真实层面 & 检测层面  (两个层面的位置在斜面上有不同)
- - 检测层面: 检测层面,为一个水平线,每一行的水平面,直线,受击检测框,攻击检测框,处于该层面,在斜面时,角色本体(根节点)根据斜面移动,检测层面所在组件移动回原始位置
- - 真实层面: 地图斜面时角色本体(根)所在层面. 在斜面时,角色本体(根节点)根据斜面移动,子弹攻击敌人时,子弹检测真实碰撞箱

除了子弹检测目标\无行属性攻击组件直线子弹植物(杨桃)\小推车检测僵尸时使用真实层面的检测框,其余检测均使用检测层面检测框

### 检测过滤
检测碰撞时会同时检测角色受击状态
  若可以检测者可以检测到目标受击状态,发射可以攻击信号
  若不能攻击,连接僵尸状态改变信号,僵尸状态改变时,重新判断是否可以攻击

植物:
```gd
enum E_BeAttackStatusPlant{
	IsNorm = 1,		## 正常
	IsFloat = 2,	## 悬浮
	IsDown = 4, 	## 地刺
	IsShort = 8, 	## 低矮植物（僵尸方子弹检测过滤 没有做僵尸方直线子弹 未使用）
}
```
僵尸:
```
enum E_BeAttackStatusZombie{
	IsNorm = 1,		## 正常
	IsJump = 2,		## 跳跃
	IsDownPool = 4,		## 水下
	IsSky = 8,			## 空中
	IsDownGround = 16,	## 地下
	IsJumpInPool = 32,	## 跳入泳池,该状态无法被高建国拦截
}
```

## 碰撞层说明
- layer 1 World : 世界层，房子区域\泳池碰撞\屋顶斜坡
- layer 2 PlantHurtBoxDetecttion : 植物层，植物所在层
- layer 3 ZombieHurtBoxDetecttion : 僵尸层，僵尸本体所在层，
- layer 4 BulletFromPlant : 植物子弹所在层，
- layer 5 ZombieHurtBoxDetecttionOnAttack : 僵尸攻击碰撞时受击碰撞箱所在层,不攻击时和本体受击碰撞箱重叠,攻击时向前移动,特殊植物可以检测(倭瓜\大嘴花)
- layer 6 ZombieHurtBoxDetecttionBeHypnotized : 僵尸被魅惑层，被魅惑僵尸改变至该层，植物子弹检测不到，
- layer 7 Bowling : 保龄球子弹层，撑杆跳僵尸可以检测到该层跳跃，
- layer 8 BulletFromZombie : 僵尸子弹区域所在层,无用
- layer 9 PlantHurtBoxReal: 植物真实受击区域
- layer 10 ZombieHurtBoxReal: 僵尸真实受击区域
- layer 11 ZombieHurtBoxRealBeHypnotized: 魅惑僵尸真实受击区域
- layer 12 ItemDetect:道具检测层(梯子、脑子等)
- layer 13 ItemReal: 道具真实层

# 主游戏 渲染层级相关
## CnavasLayer
- CanvasLayerBG (背景) : -10
- CanvasLayerCardSlot(卡槽) : 10 (-1)
- CanvasLayerFG (前景) : 5
	- - 浓雾
- CanvasLayerCardSlotSeedRain(种子雨卡槽) : 10
- CanvasLayerTemp(临时种植植物\僵尸\铲子) : 20
	- - 卡槽植物\僵尸种植虚影\铲子
- CanvasLayerEffect(全屏特效) : 30
	- - 寒冰菇\毁灭菇特效
- CanvasLayerUI(UI): 50
	- - 菜单
- CanvasLyaerConsole(控制台): 60
## 主游戏 z_index
- 第一行的 z_index (每行+50)
- - PlantCell: 10
- - - 每行PlantCell的顺序为从右向左,在 `PlantCellManager` 获取节点时,更新 `all_plant_cells` 为从左到右
- - ZombieRow: 30
- - LawnMovers : 40
- - Bullets: 45
- - - Bullet在_ready中根据lane更新 z_index=lane * 50 + 45
- - - BulletTrack: 4000 追踪子弹
- Bombs: 4001
- Suns:4002
- 被保护伞弹开的抛物线子弹：4000


# 植物种植相关
植物位置有四种: `float(漂浮植物:咖啡豆)、down(底部植物:花盆、睡莲)、norm(正常普通植物：豌豆射手)、shell(壳类植物：南瓜头)`
地形分为6种（植物格子为某一种类型+“无”类型）：`"1 无", "2 草地", "4 花盆", "8 水", "16 睡莲", "32 屋顶/裸地"`

植物种植的地形可以为多种，如豌豆射手：`22 = 2(草地) + 4(花盆)+ 16(睡莲)`
植物的位置属性只能选一种

## 植物种植条件
每个植物的种植条件使用自定义资源（`ResourcePlantCondition`），相同的种植条件可以使用同一个资源
种植条件资源需要保存在`res://resources/plant_resource/plant_condition/`目录下

植物种植条件分为特殊和非特殊,
紫卡植物一般为非特殊植物,
特殊植物需要重写对应资源脚本,重写特殊植物种植条件函数代码
特殊紫卡植物(玉米加农炮)判断是否能种植时,只走特殊植物判定种植函数,不会在走紫卡植物判定函数
双格植物只针对玉米加农炮写了个资源脚本,若扩展需写对应的资源脚本文件

## 植物格子
植物格子（`PlantCell类`）管理当前格子的植物
普通植物种植时需同时满足当前植物格子空闲位置和地形才可以种植
特殊植物需继承种植资源脚本重写判断函数判断是否可以种植

植物格子有每个位置对应的植物容器作为种植植物的父节点
原始PlantCell节点如下：
- PlantCell (PlantCell)
  - PlantDownContainer (Node2d)
  - PlantFloatContainer (Node2d)
  - PlantNormContainer (Node2d)
  - PlantShellContainer (Node2d)

本项目norm和shell位置的植物可以跟随down的植物上下移动（原版花盆种植植物后就不动了，我写完才发现，就这样了）
down位置植物需要容器节点（DownPlantSelfContainer）作为norm和shell位置植物的父节点，down位置植物移动容器节点从而带动norm和shell位置植物移动（使用动画或tween控制移动）
种植down位置植物时将植物格子的norm和shell位置的容器节点作为down位置植物的容器节点的子节点。
down位置植物节点如下：
- DownPlant(Plant)
	- DownPlantSelfContainer(Node2D)
	- DownPlantOtherNode

种植底部植物后如下所示
- PlantCell (PlantCell)
  - PlantDownContainer (Node2d)
	- DownPlant(Plant)
		- DownPlantSelfContainer(Node2D)
			- DownPlantOtherNode
			- PlantShellContainer(Node2d)
			- PlantNormContainer (Node2d)
  - PlantFloatContainer (Node2d)


## 可能踩的坑
- 1、植物需要对应的种植条件资源文件，需要在global脚本中更新对应的PlantInfo
- 2、静态迷雾_ready()函数中会调用init_static_fog()初始化静态迷雾，会删除`
@export var del_fog_postion_area:Vector2 = Vector2(650, 700)`之外的静态迷雾,如果修改屏幕显示大小，需修改该参数适应屏幕

# <mark>创建新角色(植物\僵尸)</mark>
- 角色场景都是继承的`res://scenes/character/character_000_base.tscn`场景
- - 植物场景继承`res://scenes/character/plant/plant_000_base.tscn`,
底部植物改变地形,继承`res://scenes/character/plant/plant_000_down_base.tscn`
- - 僵尸场景继承`res://scenes/character/zombie/zombie_000_base.tscn`.
- 新建角色场景后,修改对应角色类型(`plant_type`\\`zombie_type`)

## 新僵尸
从`res://scenes/character/zombie/zombie_000_base.tscn`新建继承角色
<mark>高亮部分为每个僵尸都必须修改的节点</mark>
### <mark>动画调用轨道:</mark>
- 移动的动画开头要添加方法调用:`MoveComponent._walking_start()`
- 死亡动画结尾添加方法调用:`Zombie000Base._fade_and_remove()`
- 攻击动画攻击时添加方法调用:`AttackComponent.attack_once()`
- 在不移动的动画中将ground的position轨道删除,使用AnimationTree控制动画切换,将`deterministic`属性设为false,过度动画不会混合ground的position轨道
- ground移动问题和解决方法：
- - 在每次动画结束时发射animation_finished信号设置停止移动,下一个动画若为移动动画且有过度时间,第一次移动动画会停止移动
 解决方法: 将前一个动画设置为循环(不发射animation_finished信号),设置动画过度属性`break_loop_at_end = true`
- - 若切换动画前后都有移动，动画切换时会快速移动一次，解决办法为设置动画切换间隔时停止移动（扶梯僵尸扶梯掉落）

### 影子(Shadow):
- 僵尸影子
### <mark>身体(Body):</mark>
- 僵尸身体,将僵尸的精灵节点全都放在`BodyCorrect`节点下,移动`BodyCorrect`节点,修正位置,Body节点位置默认为(0,0),在修改角色大小时,不需要移动Body位置
- 存放掉落的头\手\防具,对应掉落时激活掉落物，文件夹作用，可以不放在在节点下,`ZombieDropBase`类节点位置要为Vec(0,0),其子节点位置为对应body位置
- Body: 地图属性修改Body的位置,如泳池\屋顶斜面
- BodyCorrect: 僵尸角色本身移动body时修改BodyCorrect的位置,如跳跳\蹦极\投掷小鬼

### <mark>血量阶段变化组件(HpStageChangeComponent):</mark>
- 更新本体\防具血量临界值
- 默认每三分之一到下一阶段
- 1. 本体血量默认2个临界值,需要在body_change列表中添加两个对应掉手和掉头的资源文件
- 2. 防具血量默认3个临界值,需要在body_change_armor中添加3个对应的防具状态变化资源文件
- 若血量不按照每三分之一血量变化需要对`boundary_value_hp`赋值
- 植物使用该组件时必须对`boundary_value_hp`赋值
### <mark>血量组件(HpComponent):</mark>
- 更新僵尸本体血量\防具血量
### <mark>灰烬组件(CharredComponent):</mark>
- 将对应灰烬动画放到该节点的位置修正节点下(通用灰烬动画直接复制即可)
### 攻击组件(AttackComponent):
- 通用攻击组件,每帧攻击植物掉血
### 攻击检测组件(DetectComponent)
-  攻击组件的子组件 检测
- - 检测到僵尸:无特殊
- - 检测到植物:获取当前植物格子的应该受击的植物:Shell - Norm - Down
- 投手类攻击时,调用`update_first_enemy()`方法获取最左的敌人

### 移动组件(MoveComponent):
- 根据移动方式,选择`move_mode`为`groun`或`speed`
### 游泳碰撞盒组件(SwimBoxComponet):
- 检测僵尸是否碰撞到泳池,触发僵尸游泳
### 受击碰撞盒组件(HurtBoxComponet):
- 增加攻击时受击碰撞盒，攻击时将攻击时受击碰撞盒向前移动，部分特殊植物（大嘴花、窝瓜）可以检测到
### 掉落物品组件(DropItemComponent):
- 死亡时判断是否掉落物品(金银钻石\花园植物)


# 卡片
所有的卡片在all_card场景中,自动加载（AllCard）
游戏创建卡片时从AllCard中复制对应的卡片
创建备选卡槽卡片时，使用CardInBeCard场景文件传入参数（Card）创建，
卡片的静态角色在Card/CardBg/CharacterStatic下,调整角色的Position属性至正确的位置

# 铁器
铁器有俩种: `IronNode` 和 `IronNodeArmor`, `IronNodeArmor`从`IronNode`继承
铁器是从Body中复制的新节点,默认隐藏,当铁器被磁力菇吸走时,重新复制一份新铁器,位置不变,被磁力菇吸走


# 角色（植物和僵尸）
角色（植物和僵尸）根节点只处理基础属性、动画、body相关以及部分特殊角色功能(简单\与角色本体高度耦合不好拆分的)(土豆类准备\大嘴花攻击\魅惑)，其余全都由组件(攻击\攻击检测\移动\睡眠等基础组件)完成
信号连接必须要在角色本体中连接,除非为依赖组件(攻击行为组件与攻击检测组件)


**角色`_ready()`函数中固定根据初始化类型不同进行不同的初始化，继承的植物和僵尸不重写`_ready()`函数，而是重写`init_norm()`函数进行初始化**

角色在`add_child()`添加到节点树之前,使用init_*()函数对角色相关参数(行\初始化类型等)赋值
创建僵尸统一使用ZombieManager的create_norm_zombie()函数创建
部分主游戏全局使用的数据(植物格子\僵尸行等)放在自动加载单例MainGameDate中,每次加载主游戏场景时由对应子管理器更新赋值


## 组件信号连接
为避免信号漫天飞的情况，规定角色及其组件信号连接必需遵循以下规则（角色类的信号）：
- 角色类本身的Timer节点的timeout信号可以在编辑器中直接连接信号，组件自身的Timer信号必须连接至该组件本体节点
- 组件自定义信号父节点可以连接子节点的信号，如：
  - 攻击组件（父） 攻击检测组件（子）
- 角色速度影响的组件，在角色根节点属性中添加该组件，在角色信号连接函数中连接信号
- 组件影响组件禁用相关的，在禁用发起组件（睡眠组件、胆小组件）中添加影响组件，在角色信号连接函数中连接信号
- 除上述情况以外，其余所有自定义信号都必须由角色本体在_ready()中对应的初始化函数中连接信号

__正常出战(Norm)角色死亡必须通过血量组件掉血死亡,禁止直接删除角色__


# 存档机制
- 存档只实现了对植物数据和僵尸波次的存档

# 插件
## [anim_player_refactor](https://github.com/poohcom1/godot-animation-player-refactor)
一个 Godot 插件，用于重构 AnimationPlayer 的动画。
[插件使用教程](https://www.bilibili.com/video/BV1GxXWYZExH?spm_id_from=333.788.videopod.sections&vd_source=1005534986b111b7c1911fe1c36ac835)

注意：目录下**plugin.gd**脚本中调用的函数EditorUtil.find_animation_menu_button(base_control)只支持英文，需要进入函数修改对应的代码 func(node): return node.text == "Animation" 修改为 func(node): return node.text == "Animation" or node.text == "动画"

## [R2Ga_PVZ](https://github.com/hsk-dream/PVZ_reanim2godot_animation)
将植物大战僵尸的动画文件转换为Godot游戏引擎所支持的动画格式。[使用教程](https://www.bilibili.com/video/BV1XBKwzdELA/)
forked from [PVZ_reanim2godot_animation](https://github.com/HYTommm/PVZ_reanim2godot_animation)
